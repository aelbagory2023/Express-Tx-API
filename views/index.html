<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transaction History</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }
      h1 {
        margin-bottom: 20px;
      }
      #search {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      input,
      select,
      button {
        padding: 5px;
        font-size: 16px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
      .positive-change {
        color: green;
      }
      .negative-change {
        color: red;
      }
    </style>
  </head>
  <body>
    <h1>Transaction History</h1>

    <div id="search">
      <input
        type="text"
        id="walletAddressInput"
        placeholder="Enter wallet address"
      />
      <select id="timeFrame">
        <option value="24h">Last 24 Hours</option>
        <option value="7d">Last 7 Days</option>
        <option value="30d">Last 30 Days</option>
        <option value="1y">Last Year</option>
      </select>
      <select id="chainSelect">
        <option value="eth">Ethereum</option>
        <option value="arbitrum">Arbitrum</option>
        <option value="base">Base</option>
        <option value="solana">Solana</option>
      </select>
      <button onclick="searchTransactions()">Search Transactions</button>
    </div>
    <div id="loading" style="display: none">Loading...</div>
    <div id="result"></div>

    <script>
      async function searchTransactions() {
        const walletAddressInput =
          document.getElementById("walletAddressInput");
        const timeFrameSelect = document.getElementById("timeFrame");
        const chainSelect = document.getElementById("chainSelect");
        const walletAddress = walletAddressInput.value.trim();
        const timeFrame = timeFrameSelect.value;
        const chain = chainSelect.value;

        if (!walletAddress) {
          console.error("Please enter a wallet address");
          displayError("Please enter a wallet address");
          return;
        }

        try {
          displayLoading(true);
          const response = await fetch(
            `/api/wallet-history/${timeFrame}/${walletAddress}/${chain}`
          );
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`Failed to fetch transactions: ${errorData.error}`);
          }
          const data = await response.json();
          console.log("API response:", data);

          displayTransactions(data);
        } catch (error) {
          console.error("Error:", error.message);
          displayError(error.message);
        } finally {
          displayLoading(false);
        }
      }

      function displayTransactions(data) {
        const resultDiv = document.getElementById("result");
        if (data.transactions && data.transactions.length > 0) {
          resultDiv.innerHTML = `
            <h2>Transactions for ${data.address} on ${data.chain}</h2>
            <p>Total transactions: ${data.transactionCount}</p>
            <table>
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Hash</th>
                  <th>From</th>
                  <th>To</th>
                  <th>Value</th>
                  <th>Value at Transaction (USD)</th>
                  <th>Current Value (USD)</th>
                  <th>Price Change</th>
                  <th>Gas</th>
                  <th>Gas (USD)</th>
                  <th>Timestamp</th>
                  <th>Chain</th>
                </tr>
              </thead>
              <tbody>
                ${data.transactions
                  .map(
                    (tx) => `
                  <tr>
                    <td>${tx.type}</td>
                    <td>${tx.hash.substring(0, 10)}...</td>
                    <td>${tx.from.substring(0, 10)}...</td>
                    <td>${tx.to.substring(0, 10)}...</td>
                    <td>${
                      tx.tokenInfo
                        ? `${tx.tokenInfo.amount.toFixed(6)} ${
                            tx.tokenInfo.symbol
                          } (${tx.tokenInfo.name})`
                        : `${tx.valueNative.toFixed(6)} ${
                            tx.chain === "Solana" ? "SOL" : "ETH"
                          }`
                    }</td>
                    <td>$${tx.valueUSD.toFixed(2)}</td>
                    <td>$${tx.currentValueUSD.toFixed(2)}</td>
                    <td class="${
                      tx.priceChangeUSD >= 0
                        ? "positive-change"
                        : "negative-change"
                    }">
                      ${tx.priceChangeFormatted}
                    </td>
                    <td>${tx.gasNative.toFixed(6)} ${
                      tx.chain === "Solana" ? "SOL" : "ETH"
                    }</td>
                    <td>$${tx.gasUSD.toFixed(2)}</td>
                    <td>${new Date(tx.timestamp).toLocaleString()}</td>
                    <td>${tx.chain}</td>
                  </tr>
                `
                  )
                  .join("")}
              </tbody>
            </table>
          `;
        } else {
          resultDiv.innerHTML = `<p>No transactions found for address ${data.address} on ${data.chain}</p>`;
        }
      }

      function displayError(message) {
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML = `<p class="error">Error: ${message}</p>`;
      }

      function displayLoading(isLoading) {
        const loadingDiv = document.getElementById("loading");
        if (isLoading) {
          loadingDiv.style.display = "block";
        } else {
          loadingDiv.style.display = "none";
        }
      }
    </script>
  </body>
</html>
